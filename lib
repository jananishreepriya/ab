<?php
session_start();
$conn = mysqli_connect('localhost', 'root', '', 'library_db');
if (!$conn) die("DB connection error");
$error = '';
$message = '';
// Handle logout
if (isset($_GET['action']) && $_GET['action'] === 'logout') {
   session_destroy();
   header("Location: newfile.php");
   exit;
}
// Handle registration
if (isset($_POST['register'])) {
   $name = $_POST['name'] ?? '';
   $email = $_POST['email'] ?? '';
   $password = $_POST['password'] ?? '';
   if ($name && $email && $password) {
       $hash = password_hash($password, PASSWORD_DEFAULT);
       $q = "INSERT INTO users(name,email,password) VALUES('$name','$email','$hash')";
       if (mysqli_query($conn, $q)) {
           $message = "Registration successful! You can login now.";
       } else {
           $error = "Registration failed: " . mysqli_error($conn);
       }
   }
}
// Handle login
if (isset($_POST['login'])) {
   $email = $_POST['email'] ?? '';
   $password = $_POST['password'] ?? '';
   if ($email && $password) {
       $res = mysqli_query($conn, "SELECT * FROM users WHERE email='$email'");
       $user = mysqli_fetch_assoc($res);
       if ($user && password_verify($password, $user['password'])) {
           $_SESSION['user_id'] = $user['id'];
       } else {
           $error = "Invalid email or password";
       }
   }
}
// Require login to access book management
$logged_in = isset($_SESSION['user_id']);
// Handle adding book
if ($logged_in && isset($_POST['add_book'])) {
   $title = mysqli_real_escape_string($conn, $_POST['title'] ?? '');
   $author = mysqli_real_escape_string($conn, $_POST['author'] ?? '');
   if ($title && $author) {
       mysqli_query($conn, "INSERT INTO books(title,author) VALUES('$title','$author')");
       $message = "Book added!";
   }
}
// Handle toggle availability
if ($logged_in && isset($_GET['toggle'])) {
   $id = intval($_GET['toggle']);
   $res = mysqli_query($conn, "SELECT available FROM books WHERE id=$id");
   $row = mysqli_fetch_assoc($res);
   $new = $row['available'] ? 0 : 1;
   mysqli_query($conn, "UPDATE books SET available=$new WHERE id=$id");
   header("Location: newfile.php");
   exit;
}
// Handle delete book
if ($logged_in && isset($_GET['delete'])) {
   $id = intval($_GET['delete']);
   mysqli_query($conn, "DELETE FROM books WHERE id=$id");
   header("Location: newfile.php");
   exit;
}
// Fetch books
$search_author = $_GET['author'] ?? '';
if ($search_author) {
   $search_author = mysqli_real_escape_string($conn, $search_author);
   $query = "SELECT * FROM books WHERE author LIKE '%$search_author%'";
} else {
   $query = "SELECT * FROM books";
}
$books = mysqli_query($conn, $query);
$total_res = mysqli_query($conn, "SELECT COUNT(*) AS total FROM books");
$total_books = mysqli_fetch_assoc($total_res)['total'];
?>
<!DOCTYPE html>
<html>
<head>
<title>Library System</title>
<style>
body { font-family: Arial; max-width: 600px; margin: 20px auto; padding: 10px; color: #222;}
h1,h2 { text-align: center; }
input, button { width: 100%; padding: 8px; margin: 6px 0; box-sizing: border-box; }
button { background: black; color: white; border: none; cursor: pointer; }
button:hover { background: #333; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #666; padding: 6px; text-align: left; }
a { color: black; text-decoration: none; }
a:hover { text-decoration: underline; }
nav { text-align: center; margin-top: 15px; }
nav a { margin: 0 8px; }
.msg { color: green; text-align: center; }
.err { color: red; text-align: center; }
</style>
</head>
<body>
<h1>Public Library</h1>
<nav>
<?php if ($logged_in): ?>
   <a href="newfile.php?action=logout">Logout</a>
<?php else: ?>
   <a href="#login">Login</a> | <a href="#register">Register</a>
<?php endif; ?>
</nav>
<?php if ($message): ?><p class="msg"><?= htmlspecialchars($message) ?></p><?php endif; ?>
<?php if ($error): ?><p class="err"><?= htmlspecialchars($error) ?></p><?php endif; ?>
<?php if (!$logged_in): ?>
 <!-- Login form -->
 <h2 id="login">Login</h2>
 <form method="post">
   <input name="email" type="email" placeholder="Email" required>
   <input name="password" type="password" placeholder="Password" required>
   <button name="login">Login</button>
 </form>
 <!-- Register form -->
 <h2 id="register">Register</h2>
 <form method="post">
   <input name="name" placeholder="Name" required>
   <input name="email" type="email" placeholder="Email" required>
   <input name="password" type="password" placeholder="Password" required>
   <button name="register">Register</button>
 </form>
<?php else: ?>
<h2>Manage Books</h2>
<form method="post">
 <input name="title" placeholder="Book Title" required>
 <input name="author" placeholder="Author" required>
 <button name="add_book">Add Book</button>
</form>
<form method="get" style="margin-top:10px;">
 <input name="author" placeholder="Search by author" value="<?= htmlspecialchars($search_author) ?>">
 <button type="submit">Search</button>
 <a href="newfile.php" style="margin-left:10px;">Reset</a>
</form>
<p>Total books: <?= $total_books ?></p>
<table>
<tr><th>Title</th><th>Author</th><th>Available</th><th>Toggle</th><th>Delete</th></tr>
<?php while($b = mysqli_fetch_assoc($books)): ?>
<tr>
 <td><?= htmlspecialchars($b['title']) ?></td>
 <td><?= htmlspecialchars($b['author']) ?></td>
 <td><?= $b['available'] ? 'Yes' : 'No' ?></td>
 <td><a href="newfile.php?toggle=<?= $b['id'] ?>" onclick="return confirm('Toggle availability?')">Toggle</a></td>
 <td><a href="newfile.php?delete=<?= $b['id'] ?>" onclick="return confirm('Delete book?')">Delete</a></td>
</tr>
<?php endwhile; ?>
</table>
<?php endif; ?>
</body>
</html>


phpMyAdmin (library_db):

CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(50),
  email VARCHAR(100) UNIQUE,
  password VARCHAR(255)
);

CREATE TABLE books (
  id INT AUTO_INCREMENT PRIMARY KEY,
  title VARCHAR(100),
  author VARCHAR(100),
  available TINYINT DEFAULT 1
);
